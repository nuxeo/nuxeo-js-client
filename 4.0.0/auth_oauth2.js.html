<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: auth/oauth2.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: auth/oauth2.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const extend = require('extend');
const qs = require('querystring');

const doFetch = require('../deps/fetch');
const Promise = require('../deps/promise');

const fetchAccessToken = (baseURL, body) => {
  const url = baseURL.endsWith('/') ? baseURL : `${baseURL}/`;
  return new Promise((resolve, reject) => (
    doFetch(`${url}oauth2/token`, {
      method: 'POST',
      body: qs.stringify(body),
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    })
      .then((res) => res.json())
      .then((token) => {
        if (token.error) {
          return reject(token.error);
        }
        return resolve(token);
      })
      .catch((e) => reject(e))
  ));
};

// compatibility method to extract code and params arguments if any
const extractCodeParams = (args) => {
  switch (args.length) {
    case 0:
      // no code nor params
      return { params: {} };
    case 1:
      // only params
      return { params: args[0] };
    case 2:
    default:
      // 2 or more arguments...
      return { code: args[0], params: args[1] };
  }
};

const validateOptions = (opts) => {
  if (!opts.baseURL) {
    throw new Error('Missing `baseURL` argument');
  }
  if (!opts.clientId) {
    throw new Error('Missing `clientId` argument');
  }
};

const computeClientParams = (opts) => {
  const params = { client_id: opts.clientId };
  if (opts.clientSecret) {
    params.client_secret = opts.clientSecret;
  }
  return extend(true, params, opts.params);
};

const oauth2 = {

  /**
   * Returns the OAuth2 authorization URL.
   * @param {string} opts - The configuration options.
   * @param {string} opts.baseURL - Base URL of the Nuxeo Platform.
   * @param {string} opts.clientId - The OAuth2 client id.
   * @param {string} [opts.clientSecret] - Optional OAuth2 client secret.
   * @param {object} [opts.params] - Optional query parameters such as `state`, `redirect_uri`.
   * @returns {string}
   */
  getAuthorizationURL: (...args) => {
    // handle compat with old args
    const opts = args.length === 1 ? args[0] : {
      baseURL: args[0],
      clientId: args[1],
      params: args[2],
    };

    validateOptions(opts);

    const params = computeClientParams(opts);
    const finalParams = extend(true, { response_type: 'code' }, params);
    const url = opts.baseURL.endsWith('/') ? opts.baseURL : `${opts.baseURL}/`;
    return `${url}oauth2/authorize?${qs.stringify(finalParams)}`;
  },

  /**
   * Fetches an OAuth2 access token.
   * @param {string} baseURL - Base URL of the Nuxeo Platform.
   * @param {string} clientId - The OAuth2 client id.
   * @param {string} [code] - An authorization code. Deprecated since 3.16.0, use other helper methods instead.
   * @param {object} [params] - Optional parameters such as `redirect_uri`.
   * @returns {string}
   * @deprecated since 3.16.0, use other helper methods instead.
   */
  fetchAccessToken: (baseURL, clientId, ...args) => {
    if (!baseURL) {
      throw new Error('Missing `baseURL` argument');
    }
    if (!clientId) {
      throw new Error('Missing `clientId` argument');
    }

    // for backward compatibility if `code` is still provided
    const { code, params } = extractCodeParams(args);
    const defaultParams = code ? { code, grant_type: 'authorization_code' } : {};

    const body = extend(true, { client_id: clientId }, defaultParams, params);
    return fetchAccessToken(baseURL, body);
  },

  /**
   * Fetches an OAuth2 access token from an authorization code.
   * @param {string} opts - The configuration options.
   * @param {string} opts.baseURL - Base URL of the Nuxeo Platform.
   * @param {string} opts.clientId - The OAuth2 client id.
   * @param {string} [opts.clientSecret] - Optional OAuth2 client secret.
   * @param {string} opts.code - An authorization code.
   * @param {object} [opts.params] - Optional query parameters such as `state`, `redirect_uri`.
   * @returns {string}
   */
  fetchAccessTokenFromAuthorizationCode: (...args) => {
    // handle compat with old args
    const opts = args.length === 1 ? args[0] : {
      baseURL: args[0],
      clientId: args[1],
      code: args[2],
      params: args[3],
    };

    validateOptions(opts);
    if (!opts.code) {
      throw new Error('Missing `code` argument');
    }

    const params = computeClientParams(opts);
    const finalParams = extend(true, { code: opts.code, grant_type: 'authorization_code' }, params);
    return fetchAccessToken(opts.baseURL, finalParams);
  },

  /**
   * Fetches an OAuth2 access token from a JWT token.
   * @param {string} opts - The configuration options.
   * @param {string} opts.baseURL - Base URL of the Nuxeo Platform.
   * @param {string} opts.clientId - The OAuth2 client id.
   * @param {string} [opts.clientSecret] - Optional OAuth2 client secret.
   * @param {string} opts.jwtToken - A JWT token.
   * @param {object} [opts.params] - Optional query parameters such as `state`, `redirect_uri`.
   * @returns {string}
   */
  fetchAccessTokenFromJWTToken: (...args) => {
    // handle compat with old args
    const opts = args.length === 1 ? args[0] : {
      baseURL: args[0],
      clientId: args[1],
      jwtToken: args[2],
      params: args[3],
    };

    validateOptions(opts);
    if (!opts.jwtToken) {
      throw new Error('Missing `jwtToken` argument');
    }

    const params = computeClientParams(opts);
    const finalParams = extend(true,
      { assertion: opts.jwtToken, grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer' }, params);
    return fetchAccessToken(opts.baseURL, finalParams);
  },

  /**
   * Refreshes an OAuth2 access token.
   * @param {string} opts - The configuration options.
   * @param {string} opts.baseURL - Base URL of the Nuxeo Platform.
   * @param {string} opts.clientId - The OAuth2 client id.
   * @param {string} [opts.clientSecret] - Optional OAuth2 client secret.
   * @param {string} opts.refreshToken - A refresh token.
   * @param {object} [opts.params] - Optional query parameters such as `state`, `redirect_uri`.
   * @returns {string}
   */
  refreshAccessToken: (...args) => {
    // handle compat with old args
    const opts = args.length === 1 ? args[0] : {
      baseURL: args[0],
      clientId: args[1],
      refreshToken: args[2],
      params: args[3],
    };

    validateOptions(opts);
    if (!opts.refreshToken) {
      throw new Error('Missing `refreshToken` argument');
    }

    const params = computeClientParams(opts);
    const finalParams = extend(true,
      { refresh_token: opts.refreshToken, grant_type: 'refresh_token' }, params);
    return fetchAccessToken(opts.baseURL, finalParams);
  },
};

module.exports = oauth2;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BatchBlob.html">BatchBlob</a></li><li><a href="BatchUpload.html">BatchUpload</a></li><li><a href="Blob.html">Blob</a></li><li><a href="Directory.html">Directory</a></li><li><a href="DirectoryEntry.html">DirectoryEntry</a></li><li><a href="Document.html">Document</a></li><li><a href="Group.html">Group</a></li><li><a href="Groups.html">Groups</a></li><li><a href="Nuxeo.html">Nuxeo</a></li><li><a href="Operation.html">Operation</a></li><li><a href="Repository.html">Repository</a></li><li><a href="Request.html">Request</a></li><li><a href="ServerVersion.html">ServerVersion</a></li><li><a href="Task.html">Task</a></li><li><a href="User.html">User</a></li><li><a href="Users.html">Users</a></li><li><a href="Workflow.html">Workflow</a></li><li><a href="Workflows.html">Workflows</a></li></ul><h3>Mixins</h3><ul><li><a href="Base.html">Base</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Tue Feb 28 2023 15:42:00 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
